{% extends "base.html" %}
{% load static %}
{% block title %}üìÇ {{ carpeta.nombre }} - TACAE{% endblock %}

{% block content %}
<div class="container my-4">
  <!-- Encabezado con fondo degradado -->
  <div class="bg-primary text-white p-3 rounded d-flex align-items-center mb-3">
    <a href="{% if carpeta.padre %}{% url 'carpetas:ver_carpeta' carpeta.padre.id %}{% else %}{% url 'carpetas:listar_carpetas' %}{% endif %}" class="me-3">
      <img src="{% static 'img/volver_icon.png' %}" alt="Volver" style="width:40px;">
    </a>
    <img src="{% static 'img/tacae.jpg' %}" alt="Logo" class="rounded-circle me-3" style="width:60px;">
    <div>
      <h1 class="h4 mb-0">üìÅ {{ carpeta.nombre }}</h1>
      <small>Gestiona carpetas y documentos</small>
    </div>
  </div>
  
  <!-- Botones de acci√≥n -->
  <div class="my-3 text-center">
    {# Si la carpeta NO es de los tipos que no deben tener subcarpetas, mostramos el bot√≥n #}
    {% if carpeta.nombre|lower not in "claves,firmas,cuentas,preguntas,sistemas,bancos" and carpeta.nombre != "Control de Procesos" %}
      <button class="btn btn-outline-light bg-secondary" data-bs-toggle="modal" data-bs-target="#crearSubcarpetaModal">
        <i class="fas fa-folder-plus"></i> Crear Subcarpeta
      </button>
    {% endif %}
    {% if carpeta.padre and carpeta.padre.nombre == "Procesos Pendientes" %}
      <a href="{% url 'procesos:registrar_proceso' carpeta.id %}" class="btn btn-outline-success">
        <i class="fas fa-clipboard-list"></i> Registrar Proceso
      </a>
    {% endif %}
    {# Puedes incluir m√°s botones si lo requieres #}
  </div>
  
  {# Solo mostramos Subcarpetas y Documentos si la carpeta NO es de los tipos especificados #}
  {% if carpeta.nombre|lower not in "claves,firmas,cuentas,preguntas,sistemas,bancos" %}
  <!-- Secci√≥n de Subcarpetas -->
  <div class="mb-4">
    <h2 class="h5 text-center">Subcarpetas</h2>
    {% if carpeta.subcarpetas.all %}
      <div class="row row-cols-2 row-cols-md-4 g-3">
        {% for sub in carpeta.subcarpetas.all %}
          <div class="col">
            <div class="card text-center">
              <div class="card-body p-2">
                <i class="fas fa-folder fa-2x text-warning mb-2"></i>
                <h6 class="card-title">{{ sub.nombre }}</h6>
                <a href="{% url 'carpetas:ver_carpeta' sub.id %}" class="btn btn-sm btn-outline-primary">Ver</a>
                <a href="{% url 'carpetas:eliminar_carpeta' sub.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('¬øEliminar esta subcarpeta?');">Eliminar</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-center text-muted">No hay subcarpetas.</p>
    {% endif %}
  </div>
  
  <!-- Secci√≥n de Documentos -->
  <div class="mb-4">
    <h2 class="h5 text-center">Documentos</h2>
    {% if carpeta.documentos.all %}
      <div class="list-group">
        {% for doc in carpeta.documentos.all %}
          <a href="{{ doc.archivo.url }}" target="_blank" class="list-group-item list-group-item-action">
            <i class="fas fa-file-alt me-2"></i>{{ doc.nombre }}
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-center text-muted">No hay documentos.</p>
    {% endif %}
  </div>
  {% endif %}
  
  <!-- Secci√≥n de Procesos (Tabla) -->
  {% if carpeta.padre and carpeta.padre.nombre == "Procesos Pendientes" %}
    <div class="mb-4">
      <h2 class="h5 text-center">Procesos</h2>
      {% if carpeta.procesos.all %}
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="tableProcesos">
            <thead class="table-dark">
              <tr>
                <th>Proceso</th>
                <th>Responsable</th>
                <th>Fecha de vencimiento</th>
                <th>Observaci√≥n</th>
                <th>Posesi√≥n</th>
                <th>Estado de proceso</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for proceso in carpeta.procesos.all %}
                <tr>
                  <td>{{ proceso.proceso }}</td>
                  <td>{{ proceso.responsable }}</td>
                  <td>{{ proceso.fecha_cumplimiento }}</td>
                  <td>{{ proceso.observaciones }}</td>
                  <td>{{ proceso.posesion }}</td>
                  <td>{{ proceso.estado }}</td>
                  <td>
                    <a href="{% url 'control_procesos:editar_proceso' proceso.id %}" class="btn btn-info btn-sm">Editar</a>
                    <a href="{% url 'control_procesos:eliminar_proceso' proceso.id %}" class="btn btn-danger btn-sm" onclick="return confirm('¬øEliminar este proceso?');">Eliminar</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-center text-muted">No hay procesos.</p>
      {% endif %}
    </div>
  {% endif %}

  <!-- Secci√≥n de Sistemas (solo si carpeta es "sistema") -->
  {% if carpeta.nombre|lower == "sistema" %}
    <h4 class="mt-4">Sistemas</h4>
    <a href="{% url 'control_procesos:crear_sistema' carpeta.id %}" class="btn btn-success mb-3">
      ‚ûï Registrar Sistema
    </a>
    {% if carpeta.sistemasEspeciales.all %}
      <table class="table table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            <th>Compa√±√≠a</th>
            <th>Usuario</th>
            <th>Clave</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for item in carpeta.sistemasEspeciales.all %}
            <tr>
              <td>{{ item.compania }}</td>
              <td>{{ item.usuario }}</td>
              <td>{{ item.clave }}</td>
              <td>
                <a href="{% url 'control_procesos:editar_sistema' item.id %}" class="btn btn-info btn-sm">‚úèÔ∏è Editar</a>
                <a href="{% url 'control_procesos:eliminar_sistema' item.id %}" class="btn btn-danger btn-sm"
                   onclick="return confirm('¬øEst√°s seguro de que deseas eliminar este registro?');">
                  üóë Eliminar
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">No hay registros de Sistemas.</p>
    {% endif %}
  {% endif %}
  {% if carpeta.nombre|lower == "cuentas" %}
  <h4 class="mt-4">Cuentas Especiales</h4>
  <a href="{% url 'control_procesos:crear_cuenta_especial' carpeta.id %}" class="btn btn-success mb-3">
    ‚ûï Registrar Cuenta
  </a>

        {% if carpeta.cuentasEspeciales.all %}
          <table class="table table-bordered table-hover">
            <thead class="table-dark">
              <tr>
                <th>Compa√±√≠a</th>
                <th>Instituci√≥n financiera</th>
                <th>N√∫mero</th>
                <th>RUC / CI</th>
                <th>Usuario</th>
                <th>Clave Web</th>
                <th>Clave Cajero</th>
                <th>Clave Trush</th>
                <th>Clave SUT</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for cta in carpeta.cuentasEspeciales.all %}
                <tr>
                  <td>{{ cta.compania }}</td>
                  <td>{{ cta.institucion_financiera }}</td>
                  <td>{{ cta.numero }}</td>
                  <td>{{ cta.ruc_ci }}</td>
                  <td>{{ cta.usuario }}</td>
                  <td>{{ cta.clave_web }}</td>
                  <td>{{ cta.clave_cajero }}</td>
                  <td>{{ cta.clave_trush }}</td>
                  <td>{{ cta.clave_sut }}</td>
                  <td>
                    <a href="{% url 'control_procesos:editar_cuenta_especial' cta.id %}" class="btn btn-info btn-sm">‚úèÔ∏è Editar</a>
                    <a href="{% url 'control_procesos:eliminar_cuenta_especial' cta.id %}" class="btn btn-danger btn-sm"
                      onclick="return confirm('¬øEst√°s seguro de eliminar esta cuenta?');">
                      üóë Eliminar
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted">No hay cuentas registradas.</p>
        {% endif %}
      {% endif %}

  <!-- Secci√≥n de Claves (solo si carpeta es "claves") -->
  {% if carpeta.nombre|lower == "claves" %}
    <h4 class="mt-4">Claves Sistemas</h4>
    <a href="{% url 'control_procesos:crear_claves_sistemas' carpeta.id %}" class="btn btn-success mb-3">
      ‚ûï Registrar Claves
    </a>
    {% if carpeta.clavesSistemas.all %}
      <table class="table table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            <th>Compa√±√≠a</th>
            <th>Cant√≥n</th>
            <th>Email</th>
            <th>Clave mail</th>
            <th>Fecha Declaraci√≥n</th>
            <th>Declaraci√≥n</th>
            <th>RUC</th>
            <th>Clave SRI</th>
            <th>Clave Super</th>
            <th>Clave IESS</th>
            <th>Perito judicial</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for item in carpeta.clavesSistemas.all %}
            <tr>
              <td>{{ item.compania }}</td>
              <td>{{ item.canton }}</td>
              <td>{{ item.email }}</td>
              <td>{{ item.clave_mail }}</td>
              <td>{{ item.fecha_declaracion|date:"d/m/Y" }}</td>
              <td>{{ item.declaracion }}</td>
              <td>{{ item.ruc }}</td>
              <td>{{ item.clave_sri }}</td>
              <td>{{ item.clave_super }}</td>
              <td>{{ item.clave_iess }}</td>
              <td>{{ item.perito_judicial }}</td>
              <td>
                <a href="{% url 'control_procesos:editar_claves_sistemas' item.id %}" class="btn btn-info btn-sm">‚úèÔ∏è Editar</a>
                <a href="{% url 'control_procesos:eliminar_claves_sistemas' item.id %}" class="btn btn-danger btn-sm"
                   onclick="return confirm('¬øEst√°s seguro de eliminar este registro?');">
                  üóë Eliminar
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">No hay registros de Claves Sistemas.</p>
    {% endif %}
  {% endif %}

  <!-- Secci√≥n de Firmas (solo si carpeta es "firmas") -->
  {% if carpeta.nombre|lower == "firmas" %}
    <h4 class="mt-4">Firmas</h4>
    <a href="{% url 'control_procesos:crear_firma' carpeta.id %}" class="btn btn-success mb-3">‚ûï Registrar Firma</a>
    {% if carpeta.firmas.all %}
      <table class="table table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            <th>Perito</th>
            <th>RUC</th>
            <th>Clave</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for firma in carpeta.firmas.all %}
            <tr>
              <td>{{ firma.perito }}</td>
              <td>{{ firma.ruc }}</td>
              <td>{{ firma.clave }}</td>
              <td>
                <a href="{% url 'control_procesos:editar_firma' firma.id %}" class="btn btn-info btn-sm">‚úèÔ∏è Editar</a>
                <a href="{% url 'control_procesos:eliminar_firma' firma.id %}" class="btn btn-danger btn-sm" onclick="return confirm('¬øEst√°s seguro de eliminar esta firma?');">
                  üóë Eliminar
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">No hay firmas registradas.</p>
    {% endif %}
  {% endif %}

  <!-- Secci√≥n de Bancos (solo si carpeta es "bancos") -->
  {% if carpeta.nombre|lower == "bancos" %}
    <h4 class="mt-4">üè¶ Informaci√≥n de Bancos</h4>
    <a href="{% url 'control_procesos:crear_banco' carpeta.id %}" class="btn btn-success mb-3">
      ‚ûï Registrar Banco
    </a>
    {% if carpeta.bancos.all %}
      <table class="table table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            <th>Compa√±√≠a</th>
            <th>Instituci√≥n Financiera</th>
            <th>N√∫mero</th>
            <th>RUC/CI</th>
            <th>Usuario</th>
            <th>Clave Web</th>
            <th>Saldo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for banco in carpeta.bancos.all %}
            <tr>
              <td>{{ banco.compania }}</td>
              <td>{{ banco.institucion_financiera }}</td>
              <td>{{ banco.numero }}</td>
              <td>{{ banco.ruc_ci }}</td>
              <td>{{ banco.usuario }}</td>
              <td>{{ banco.clave_web }}</td>
              <td>${{ banco.saldo }}</td>
              <td>
                <a href="{% url 'control_procesos:editar_banco' banco.id %}" class="btn btn-info btn-sm">‚úèÔ∏è Editar</a>
                <a href="{% url 'control_procesos:eliminar_banco' banco.id %}" class="btn btn-danger btn-sm"
                   onclick="return confirm('¬øSeguro que deseas eliminar este banco?');">üóë Eliminar</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">üìÇ No hay bancos registrados.</p>
    {% endif %}
  {% endif %}

  <!-- Secci√≥n de Preguntas (solo si carpeta es "preguntas") -->
  {% if carpeta.nombre|lower == "preguntas" %}
    <h4 class="mt-4">Preguntas y Respuestas</h4>
    <a href="{% url 'control_procesos:crear_pregunta' carpeta.id %}" class="btn btn-success mb-3">
      ‚ûï Registrar Pregunta
    </a>
    {% if carpeta.preguntasEspeciales.all %}
      <table class="table table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            <th>Pregunta</th>
            <th>Respuesta</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for preg in carpeta.preguntasEspeciales.all %}
            <tr>
              <td>{{ preg.pregunta }}</td>
              <td>{{ preg.respuesta }}</td>
              <td>
                <a href="{% url 'control_procesos:editar_pregunta' preg.id %}" class="btn btn-info btn-sm">‚úèÔ∏è Editar</a>
                <a href="{% url 'control_procesos:eliminar_pregunta' preg.id %}" class="btn btn-danger btn-sm"
                   onclick="return confirm('¬øEst√°s seguro de que deseas eliminar esta pregunta?');">
                  üóë Eliminar
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">No hay preguntas registradas.</p>
    {% endif %}
  {% endif %}

  <!-- Botones de Navegaci√≥n -->
  <div class="mt-3 text-center">
    <a href="{% if carpeta.padre %}{% url 'carpetas:ver_carpeta' carpeta.padre.id %}{% else %}{% url 'carpetas:listar_carpetas' %}{% endif %}" class="btn btn-outline-secondary action-btn">
      ‚¨Ö Volver carpeta anterior
    </a>
    <a href="{% url 'home' %}" class="btn btn-outline-primary action-btn">üè† Inicio</a>
    <a href="{% url 'carpetas:listar_carpetas' %}" class="btn btn-outline-info action-btn">üìÇ Carpeta Principal</a>
  </div>
</div>  <!-- Fin del container -->

<!-- Script para filtros (si los usas en tus tablas) -->
<script>
function setupFilter(inputId, tableId) {
  document.getElementById(inputId)?.addEventListener('keyup', function() {
    const q = this.value.toLowerCase();
    document.querySelectorAll(`#${tableId} tbody tr`).forEach(r => {
      r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
}
setupFilter('searchProcesos','tableProcesos');
setupFilter('searchCuentas','tableCuentas');
setupFilter('searchCxc','tableCxc');
</script>

<!-- Recursos Externos -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
